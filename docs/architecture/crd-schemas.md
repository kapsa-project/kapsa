# CRD Schemas

## Overview

Kapsa defines four primary Custom Resource Definitions:

1. **Project** - Developer-facing: defines application, repository, environments
2. **Environment** - Runtime configuration for a specific deployment target (dev/staging/prod/preview)
3. **DomainPool** - Platform admin: defines available base domains for routing
4. **Registry** - Platform admin: defines container registry endpoints

## Project CRD

The Project is the primary developer interface. It defines the application, source repository, build configuration, and desired environments.

### Schema

```yaml
apiVersion: kapsa-project.io/v1alpha1
kind: Project
metadata:
  name: api-service
  namespace: default
spec:
  # Source repository configuration
  repository:
    url: https://github.com/example/api-service.git
    branch: main # Default branch for production
    pollInterval: 300 # Poll interval in seconds (default: 300)

  # Build configuration
  build:
    strategy: buildpack # "dockerfile" or "buildpack"
    dockerfile: Dockerfile # Required if strategy=dockerfile
    context: . # Build context path

  # Registry configuration (references Registry CRD)
  registry:
    name: company-harbor # Reference to Registry CRD
    imageRepository: myapp/api-service # Path within registry

  # Domain configuration
  domain:
    subdomain: api # Subdomain for this project
    domainPoolRef: corporate-apps # Reference to DomainPool CRD

  # Environments to deploy
  environments:
    - name: dev
      branch: develop
      autoSync: true # Auto-deploy on source changes

    - name: staging
      branch: main
      autoSync: true

    - name: prod
      branch: main
      autoSync: false # Manual promotion only

  # Preview environment configuration
  previewEnvironments:
    enabled: true
    ttl: 168h # 7 days
    branches:
      include: ["feature/*", "fix/*"]
      exclude: ["main", "develop"]

status:
  conditions:
    - type: Ready
      status: "True"
      lastTransitionTime: "2025-10-02T12:00:00Z"

  latestCommit: abc123def456
  latestImage: harbor.corp.com/myapp/api-service:abc123d

  environments:
    - name: dev
      ready: true
      url: https://dev.api.apps.corp.com

    - name: prod
      ready: true
      url: https://api.apps.corp.com
```

### Key Fields

- **`spec.repository`**: Git repository configuration and polling settings
- **`spec.build`**: Build strategy (Dockerfile vs Buildpacks)
- **`spec.registry`**: Reference to Registry CRD and image path
- **`spec.domain`**: Subdomain and DomainPool reference
- **`spec.environments[]`**: List of permanent environments
- **`spec.previewEnvironments`**: Configuration for ephemeral branch previews
- **`status.environments[]`**: Current state and URLs of all environments

## Environment CRD

Environment represents a specific deployment target. Created and managed by the Kapsa operator based on Project spec.

### Schema

```yaml
apiVersion: kapsa-project.io/v1alpha1
kind: Environment
metadata:
  name: api-service-dev
  namespace: api-service-ns
  ownerReferences:
    - apiVersion: kapsa-project.io/v1alpha1
      kind: Project
      name: api-service
      uid: <project-uid>
      controller: true

spec:
  # Reference to parent Project
  projectRef:
    name: api-service

  # Environment type
  type: permanent # "permanent" or "preview"
  branch: develop # Git branch for this environment

  # Runtime configuration
  runtime:
    replicas: 2

    resources:
      limits:
        cpu: "1000m"
        memory: "512Mi"
      requests:
        cpu: "100m"
        memory: "128Mi"

    autoscaling:
      enabled: true
      minReplicas: 2
      maxReplicas: 10
      targetCPUUtilization: 80

    ports:
      - name: http
        containerPort: 8080
        protocol: TCP

  # Ingress configuration
  ingress:
    enabled: true
    host: dev.api.apps.corp.com
    tls:
      enabled: true
      secretName: dev-api-tls # Generated by cert-manager

  # Configuration references (no inline secrets)
  configRefs:
    - configMapRef:
        name: api-config-dev

  secretRefs:
    - secretRef:
        name: api-secrets-dev # Managed by ESO/Vault

  # Environment variables (non-sensitive only)
  env:
    - name: ENVIRONMENT
      value: "development"
    - name: LOG_LEVEL
      value: "debug"

status:
  conditions:
    - type: Ready
      status: "True"

  phase: Running # Pending/Building/Running/Failed

  image: harbor.corp.com/myapp/api-service:abc123d

  resources:
    deploymentName: api-service-dev
    serviceName: api-service-dev
    ingressName: api-service-dev

  urls:
    - https://dev.api.apps.corp.com

  # Preview-specific fields
  expiresAt: "2025-10-09T12:00:00Z" # Only for preview environments
```

### Key Fields

- **`spec.type`**: `permanent` (dev/staging/prod) or `preview` (ephemeral)
- **`spec.runtime`**: Pod replicas, resources, autoscaling, ports
- **`spec.ingress`**: Domain and TLS configuration
- **`spec.configRefs`**: References to ConfigMaps (no inline config)
- **`spec.secretRefs`**: References to Secrets (no inline secrets)
- **`status.resources`**: Names of created Kubernetes resources
- **`status.expiresAt`**: TTL timestamp for preview environments

## DomainPool CRD

DomainPool defines base domains available for application routing. Managed by platform administrators.

### Schema

```yaml
apiVersion: kapsa-project.io/v1alpha1
kind: DomainPool
metadata:
  name: corporate-apps

spec:
  # Base domains available for allocation
  baseDomains:
    - apps.corp.com
    - services.corp.com

  # cert-manager issuer for TLS
  certManager:
    issuerRef:
      name: letsencrypt-prod
      kind: ClusterIssuer

  # Allocation policy
  allocationPolicy:
    strategy: round-robin # How to select from multiple base domains
    reservedSubdomains: # Subdomains that cannot be allocated
      - www
      - admin
      - internal

status:
  conditions:
    - type: Ready
      status: "True"

  allocations:
    - subdomain: api
      baseDomain: apps.corp.com
      project: api-service
      environment: prod
```

### Key Fields

- **`spec.baseDomains[]`**: Available base domains (e.g., `apps.corp.com`)
- **`spec.certManager.issuerRef`**: Reference to cert-manager ClusterIssuer or Issuer (challenge type configured in the issuer itself)
- **`spec.allocationPolicy`**: Rules for domain allocation
- **`status.allocations[]`**: Currently allocated subdomains

## Registry CRD

Registry defines container registry endpoints and authentication. Managed by platform administrators.

### Schema

```yaml
apiVersion: kapsa-project.io/v1alpha1
kind: Registry
metadata:
  name: company-harbor

spec:
  # Registry type and endpoint
  type: harbor # "harbor", "gitlab", "docker", "ecr", "gcr", "acr"
  endpoint: https://harbor.corp.com

  # Authentication (references Secret, no inline credentials)
  auth:
    secretRef:
      name: harbor-push-credentials
      namespace: kapsa-system

    # Secret must contain:
    # - username (for Docker/Harbor/GitLab)
    # - password (for Docker/Harbor/GitLab)
    # OR
    # - .dockerconfigjson (for advanced auth)

  # Registry-specific configuration
  options:
    projectName: infrastructure # Harbor project name
    robotAccount: true # Use Harbor robot account

  # Push/pull policies
  imagePullSecret:
    name: harbor-pull-secret # Secret name to create in project namespaces
    generatePerNamespace: true # Create copy in each project namespace

status:
  conditions:
    - type: Ready
      status: "True"

  verified: true # Registry connectivity verified
  lastVerified: "2025-10-02T12:00:00Z"
```

### Key Fields

- **`spec.type`**: Registry type (harbor, gitlab, docker, ecr, gcr, acr)
- **`spec.endpoint`**: Registry URL
- **`spec.auth.secretRef`**: Reference to Secret with credentials (no inline secrets)
- **`spec.options`**: Registry-specific configuration
- **`spec.imagePullSecret`**: Configuration for generating pull secrets in project namespaces
- **`status.verified`**: Registry connectivity and auth verification status

## CRD Relationships

```txt
DomainPool (cluster-scoped)
    |
    | referenced by
    |
Project (namespace-scoped)
    | creates
    |
Environment (namespace-scoped)
    | creates
    |
Deployment, Service, Ingress (Kubernetes core)


Registry (cluster-scoped)
    |
    | referenced by
    |
Project
    | triggers
    |
kpack Image (namespace-scoped)
    | pushes to
    |
Container Registry (external)
```

## Status Conditions

All CRDs follow Kubernetes conventions for status conditions:

```yaml
status:
  conditions:
    - type: Ready # Overall readiness
      status: "True" # True/False/Unknown
      reason: AllEnvironmentsReady
      message: "All environments are running"
      lastTransitionTime: "2025-10-02T12:00:00Z"

    - type: BuildSucceeded
      status: "True"
      reason: ImagePushed
      message: "Image built and pushed: harbor.corp.com/myapp/api:abc123d"
      lastTransitionTime: "2025-10-02T11:55:00Z"
```

### Common Condition Types

**Project:**

- `Ready`: All environments healthy
- `BuildSucceeded`: Latest build completed successfully
- `RepositoryAccessible`: Git repository is accessible

**Environment:**

- `Ready`: Deployment is running and healthy
- `IngressReady`: Ingress is configured and accessible
- `TLSReady`: TLS certificate provisioned

**DomainPool:**

- `Ready`: Cert-manager issuer is ready

**Registry:**

- `Ready`: Registry is accessible and authenticated
